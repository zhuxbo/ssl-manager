name: Sync to Gitee

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:

env:
  GITEE_OWNER: zhuxbo
  GITEE_REPO: cert-manager

# 并发控制：同一 ref 的 workflow 取消旧的，避免重复上传
concurrency:
  group: gitee-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-code:
    name: Sync Code to Gitee
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && !contains(github.repository, '-dev')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Gitee
        run: |
          git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}.git

          if [ "${{ github.ref_type }}" == "branch" ]; then
            git push gitee HEAD:${{ github.ref_name }} --force
          else
            git push gitee ${{ github.ref_name }} --force
          fi

  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && !contains(github.repository, '-dev')

    steps:
      - name: Get release info
        id: release_info
        run: |
          # 从触发的 workflow run 获取 tag
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "Head branch/tag: $HEAD_BRANCH"

          # 获取 release 信息
          RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$HEAD_BRANCH")

          echo "Release response: $RELEASE"

          TAG=$(echo "$RELEASE" | jq -r '.tag_name')
          NAME=$(echo "$RELEASE" | jq -r '.name')
          PRERELEASE=$(echo "$RELEASE" | jq -r '.prerelease')

          if [ "$TAG" == "null" ] || [ -z "$TAG" ]; then
            echo "No release found for tag $HEAD_BRANCH"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all assets
        if: steps.release_info.outputs.skip != 'true'
        run: |
          mkdir -p assets
          RELEASE_TAG="${{ steps.release_info.outputs.tag }}"

          echo "Downloading assets for $RELEASE_TAG..."
          gh release download "$RELEASE_TAG" --repo ${{ github.repository }} --dir assets || true

          ls -la assets/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Gitee Release
        if: steps.release_info.outputs.skip != 'true'
        run: |
          RELEASE_TAG="${{ steps.release_info.outputs.tag }}"
          RELEASE_NAME="${{ steps.release_info.outputs.name }}"
          PRERELEASE="${{ steps.release_info.outputs.prerelease }}"

          echo "Creating Gitee release for $RELEASE_TAG..."

          # 查询并删除 Gitee 现有 release
          EXISTING=$(curl -s "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/tags/$RELEASE_TAG?access_token=${{ secrets.GITEE_TOKEN }}")
          EXISTING_ID=$(echo "$EXISTING" | jq -r 'if type == "object" then .id else empty end')

          if [ -n "$EXISTING_ID" ]; then
            echo "Found existing Gitee release: $EXISTING_ID, deleting..."

            # 删除 release（带响应码检查）
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
              "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/$EXISTING_ID?access_token=${{ secrets.GITEE_TOKEN }}")

            echo "Delete response code: $HTTP_CODE"

            if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "Delete successful, waiting for propagation..."
              sleep 5
            else
              echo "::error::Failed to delete Gitee release (HTTP $HTTP_CODE)"
              echo "Please manually delete the release and re-run"
              exit 1
            fi

            # 验证删除成功（最多重试 3 次）
            for i in 1 2 3; do
              sleep 3
              VERIFY=$(curl -s "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/tags/$RELEASE_TAG?access_token=${{ secrets.GITEE_TOKEN }}")
              if ! echo "$VERIFY" | jq -e '.id' > /dev/null 2>&1; then
                echo "Verified: release deleted successfully"
                break
              fi
              echo "Release still exists, waiting... (attempt $i/3)"
              if [ "$i" = "3" ]; then
                echo "::error::Release still exists after delete, please manually delete"
                exit 1
              fi
            done
          else
            echo "No existing release found for tag: $RELEASE_TAG"
          fi

          # 获取 GitHub Release 的 body
          GH_BODY=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG" | jq -r '.body // empty')

          # 如果获取失败，使用默认内容
          if [ -z "$GH_BODY" ]; then
            GH_BODY="SSL Manager $RELEASE_TAG"
          fi

          # 转义 JSON 特殊字符
          GH_BODY_ESCAPED=$(echo "$GH_BODY" | jq -Rs '.')

          # 创建新 release
          RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases" \
            -H "Content-Type: application/json" \
            -d "{
              \"access_token\": \"${{ secrets.GITEE_TOKEN }}\",
              \"tag_name\": \"$RELEASE_TAG\",
              \"name\": \"$RELEASE_NAME\",
              \"body\": $GH_BODY_ESCAPED,
              \"prerelease\": $PRERELEASE,
              \"target_commitish\": \"dev\"
            }")

          echo "Create release response: $RESPONSE"
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ "$RELEASE_ID" == "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "Failed to create release"
            exit 1
          fi

          echo "Release ID: $RELEASE_ID"

          # 上传附件
          for file in assets/*; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              curl -s -X POST "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/$RELEASE_ID/attach_files" \
                -H "Content-Type: multipart/form-data" \
                -F "access_token=${{ secrets.GITEE_TOKEN }}" \
                -F "file=@$file"
            fi
          done

      - name: Sync latest release (stable)
        if: steps.release_info.outputs.skip != 'true' && steps.release_info.outputs.prerelease == 'false'
        run: |
          echo "Syncing latest release to Gitee..."

          # 推送 latest tag
          git clone --depth 1 https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}.git /tmp/gitee-repo
          cd /tmp/gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -d latest 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true
          git tag latest
          git push origin latest

          # 下载 latest 包
          cd /tmp
          mkdir -p latest-assets
          gh release download latest --repo ${{ github.repository }} --dir latest-assets || true
          ls -la latest-assets/

          # 创建/更新 Gitee latest release
          RELEASE_TAG="latest"
          VERSION="${{ steps.release_info.outputs.tag }}"

          # 查询并删除 Gitee 现有 latest release
          EXISTING=$(curl -s "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/tags/latest?access_token=${{ secrets.GITEE_TOKEN }}")
          EXISTING_ID=$(echo "$EXISTING" | jq -r 'if type == "object" then .id else empty end')

          if [ -n "$EXISTING_ID" ]; then
            echo "Found existing latest release: $EXISTING_ID, deleting..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
              "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/$EXISTING_ID?access_token=${{ secrets.GITEE_TOKEN }}")

            if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "Delete successful"
              sleep 5
            else
              echo "::warning::Failed to delete latest release (HTTP $HTTP_CODE)"
            fi
          else
            echo "No existing latest release found"
          fi

          # 创建新的 latest release
          LATEST_BODY="当前最新稳定版本: **${VERSION}**"
          LATEST_BODY_ESCAPED=$(echo "$LATEST_BODY" | jq -Rs '.')

          RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases" \
            -H "Content-Type: application/json" \
            -d "{
              \"access_token\": \"${{ secrets.GITEE_TOKEN }}\",
              \"tag_name\": \"latest\",
              \"name\": \"Latest Stable Release ($VERSION)\",
              \"body\": $LATEST_BODY_ESCAPED,
              \"prerelease\": false,
              \"target_commitish\": \"main\"
            }")

          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "Created latest release: $RELEASE_ID"

          # 上传 latest 包
          if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
            for file in latest-assets/*latest*; do
              if [ -f "$file" ]; then
                echo "Uploading: $file"
                curl -s -X POST "https://gitee.com/api/v5/repos/${{ env.GITEE_OWNER }}/${{ env.GITEE_REPO }}/releases/$RELEASE_ID/attach_files" \
                  -H "Content-Type: multipart/form-data" \
                  -F "access_token=${{ secrets.GITEE_TOKEN }}" \
                  -F "file=@$file"
              fi
            done
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
